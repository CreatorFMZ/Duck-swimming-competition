<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8" />
<title>é¸­å­æ¸¸æ³³æ¯”èµ›</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<style>
  :root { --water:#b9ecff; --border:#077; --text:#044; --btn:#0aa; --btn2:#ff6b39; --btn3:#5c7cfa; }
  *{box-sizing:border-box}
  body{ margin:0; padding:12px; font-family:"Segoe UI","PingFang SC","Microsoft Yahei",system-ui,-apple-system,sans-serif;
        background:linear-gradient(#eaf9ff,#d8f2ff); color:var(--text); }
  h1{margin:6px 0 10px; text-align:center}
  .panel{ max-width:1200px; margin:0 auto 10px; padding:10px; background:#fff; border:2px solid var(--border);
          border-radius:12px; box-shadow:0 6px 18px rgba(0,0,0,.06); }
  .row{display:flex; gap:10px; align-items:center; flex-wrap:wrap; justify-content:center}
  label{font-weight:600}
  input[type=number]{ width:110px; padding:8px 10px; font-size:14px; border:2px solid var(--border); border-radius:8px; color:var(--text); }
  button{ border:none; color:#fff; padding:10px 18px; font-size:16px; border-radius:10px; cursor:pointer;
          box-shadow:0 4px 10px rgba(0,0,0,.08); }
  #btnStart{ background:var(--btn2) }  #btnReset{ background:var(--btn) }  #btnSettings{ background:var(--btn3) }
  .badge{ background:#fff; border:1px solid var(--border); border-radius:10px; padding:6px 10px;
          font-size:14px; box-shadow:0 4px 10px rgba(0,0,0,.06); }

  #trackWrap{
    position:relative; height:600px; overflow:hidden;
    background: var(--water);
    border:2px solid var(--border); border-radius:16px;
  }
  #finishLine{
    position:absolute; top:0; width:10px; height:100%;
    background:repeating-linear-gradient(180deg,#fff 0 10px,#ffca28 10px 20px);
    right:90px; box-shadow:-2px 0 0 rgba(0,0,0,.1) inset;
  }

  .duck{
    position:absolute; left:10px; width:64px; height:52px;
    transform-origin:center; 
    transition: transform .12s, opacity 0.3s ease-in-out;
    user-select:none; pointer-events:none;
    opacity: 1;
  }
  .duck.finish{ transform: scale(1.06) }
  .duck.hiding { opacity: 0; }
  .duck svg{ width:100%; height:100%; display:block; }

  .label{
    position:absolute; left:50%; transform:translate(-50%, -115%);
    background:#ffffff; color:#333; border-radius:10px;
    padding:2px 6px; font-size:12px; line-height:1;
    box-shadow:0 1px 3px rgba(0,0,0,.15);
    white-space:nowrap;
    transition: opacity 0.3s ease-in-out;
    opacity: 1;
  }
  .label.hiding { opacity: 0; }

  #hud{ display:flex; gap:10px; align-items:center; flex-wrap:wrap; justify-content:center; margin-top:6px }
  #result ol{margin:6px 0 0 22px}
  #result li{margin:2px 0; line-height:1.5}
  
  /* å† å†›å¼¹çª—æ ·å¼ */
  .winner-modal {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0,0,0,0.5);
    display: flex;
    justify-content: center;
    align-items: center;
    z-index: 1000;
  }
  .winner-content {
    background: white;
    padding: 30px;
    border-radius: 15px;
    text-align: center;
    box-shadow: 0 10px 30px rgba(0,0,0,0.3);
    max-width: 400px;
    width: 90%;
    border: 3px solid #ffca28;
  }
  .winner-title {
    font-size: 24px;
    font-weight: bold;
    color: #ff6b39;
    margin-bottom: 15px;
  }
  .winner-info {
    font-size: 18px;
    margin-bottom: 20px;
    color: #333;
  }
  .winner-time {
    font-size: 22px;
    font-weight: bold;
    color: #077;
    margin: 10px 0;
  }
  .close-winner {
    background: var(--btn);
    color: white;
    border: none;
    padding: 10px 20px;
    border-radius: 8px;
    font-size: 16px;
    cursor: pointer;
    margin-top: 10px;
  }
  
  /* è®¾ç½®å¼¹çª—æ ·å¼ */
  .settings-modal {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0,0,0,0.5);
    display: flex;
    justify-content: center;
    align-items: center;
    z-index: 1000;
  }
  .settings-content {
    background: white;
    padding: 25px;
    border-radius: 15px;
    box-shadow: 0 10px 30px rgba(0,0,0,0.3);
    max-width: 450px;
    width: 90%;
    border: 3px solid var(--btn3);
  }
  .settings-title {
    font-size: 22px;
    font-weight: bold;
    color: var(--btn3);
    margin-bottom: 20px;
    text-align: center;
  }
  .settings-group {
    margin-bottom: 20px;
  }
  .settings-label {
    display: block;
    margin-bottom: 8px;
    font-weight: 600;
    color: #333;
  }
  .settings-select, .settings-checkbox {
    width: 100%;
    padding: 8px 10px;
    font-size: 14px;
    border: 2px solid var(--border);
    border-radius: 8px;
    color: var(--text);
    margin-bottom: 10px;
  }
  .settings-checkbox {
    width: auto;
    margin-right: 8px;
  }
  .checkbox-container {
    display: flex;
    align-items: center;
    margin-bottom: 10px;
  }
  .settings-footer {
    margin-top: 25px;
    padding-top: 15px;
    border-top: 1px solid #eee;
    text-align: center;
  }
  .github-link {
    color: var(--btn);
    text-decoration: none;
    font-size: 14px;
  }
  .github-link:hover {
    text-decoration: underline;
  }
  .close-settings {
    background: var(--btn);
    color: white;
    border: none;
    padding: 10px 20px;
    border-radius: 8px;
    font-size: 16px;
    cursor: pointer;
    margin-top: 10px;
    width: 100%;
  }
</style>
</head>
<body>
  <h1 id="pageTitle">é¸­å­æ¸¸æ³³æ¯”èµ› ğŸ¦†</h1>

  <div class="panel">
    <div class="row">
      <label id="duckCountLabel">é¸­å­æ•°é‡ï¼š<input id="n" type="number" min="1" max="2147483648" value="5" /></label>
      <label id="speedMultiplierLabel">é€Ÿåº¦å€æ•°ï¼š<input id="speedMul" type="number" min="0.01" max="100" step="0.01" value="1" /></label>
      <button id="btnStart">å¼€å§‹æ¯”èµ›</button>
      <button id="btnReset">æ¸…ç©º</button>
      <button id="btnSettings">è®¾ç½®</button>
    </div>
    <div id="hud">
      <div class="badge" id="statusLabel">çŠ¶æ€ï¼š<span id="status">ç­‰å¾…å¼€å§‹</span></div>
      <div class="badge" id="finishedLabel">å·²å®Œèµ›ï¼š<span id="doneCnt">0</span>/<span id="totalCnt">5</span></div>
      <div class="badge" id="timeUsedLabel">ç”¨æ—¶ï¼š<span id="elapsed">0.0000s</span></div>
    </div>
  </div>

  <div id="trackWrap" class="panel">
    <div id="finishLine" title="ç»ˆç‚¹"></div>
  </div>

  <div id="result" class="panel">
    <h2 id="raceResultTitle">æ¯”èµ›ç»“æœ</h2>
    <ol id="rankList"></ol>
  </div>

<script>
(function(){
  // è¿åŠ¨å‚æ•° & å¤–è§‚
  const UNIT_TO_PX = 80;
  // å¢åŠ é€Ÿåº¦å·®ï¼šå°†é€Ÿåº¦èŒƒå›´ä»åŸæ¥çš„1.2-2.4æ‰©å±•åˆ°0.3-3.0
  const SPEED_MIN  = 0.3;  // åŸæ¥ä¸º0.6*2=1.2
  const SPEED_MAX  = 3.0;  // åŸæ¥ä¸º1.2*2=2.4
  const LEFT_PAD   = 10;
  const FINISH_RIGHT_PADDING = 90;
  
  // è®¾ç½®
  let settings = {
    language: 'zh',
    showWinnerModal: true,
    soundOn: true
  };
  
  // å¤šè¯­è¨€æ”¯æŒ
  const translations = {
    zh: {
      title: "é¸­å­æ¸¸æ³³æ¯”èµ› ğŸ¦†",
      duckCount: "é¸­å­æ•°é‡ï¼š",
      speedMultiplier: "é€Ÿåº¦å€æ•°ï¼š",
      startRace: "å¼€å§‹æ¯”èµ›",
      reset: "æ¸…ç©º",
      settings: "è®¾ç½®",
      status: "çŠ¶æ€ï¼š",
      finished: "å·²å®Œèµ›ï¼š",
      timeUsed: "ç”¨æ—¶ï¼š",
      raceResult: "æ¯”èµ›ç»“æœ",
      waiting: "ç­‰å¾…å¼€å§‹",
      racing: "æ¯”èµ›ä¸­â€¦",
      ended: "å·²ç»“æŸ",
      settingsTitle: "è®¾ç½®",
      language: "è¯­è¨€",
      showWinner: "æ˜¾ç¤ºå† å†›å¼¹çª—",
      sound: "å¼€å¯å£°éŸ³",
      saveSettings: "ä¿å­˜è®¾ç½®",
      github: "è½¬åˆ°https://github.com/CreatorFMZ/Duck-swimming-competitionä»¥è·å–æœ€æ–°ç‰ˆ"
    },
    en: {
      title: "Duck Swimming Competition ğŸ¦†",
      duckCount: "Duck Count:",
      speedMultiplier: "Speed Multiplier:",
      startRace: "Start Race",
      reset: "Reset",
      settings: "Settings",
      status: "Status:",
      finished: "Finished:",
      timeUsed: "Time:",
      raceResult: "Race Results",
      waiting: "Waiting",
      racing: "Racing...",
      ended: "Ended",
      settingsTitle: "Settings",
      language: "Language",
      showWinner: "Show Winner Popup",
      sound: "Enable Sound",
      saveSettings: "Save Settings",
      github: "Go to https://github.com/CreatorFMZ/Duck-swimming-competition for the latest version"
    }
  };

  // çŠ¶æ€
  let ducks = [];       // {id, duckEl, labelEl, x, y, speed, finished, finishTime}
  let running = false;
  let startPerf = 0, lastPerf = 0;
  let speedTimer = null, quackTimer = null, rafId = 0, finishX = 0;

  // éŸ³æ•ˆï¼ˆWebAudio ä¸‰è¿"å˜å˜å˜"ï¼‰
  let audioCtx = null;
  function initAudio(){
    if (!audioCtx) {
      const AC = window.AudioContext || window.webkitAudioContext;
      audioCtx = new AC();
    }
  }
  function singleQuack(vol=0.28, dur=0.16, f0=520, f1=240){
    if (!settings.soundOn) return;
    initAudio();
    const ctx = audioCtx, now = ctx.currentTime;
    const osc = ctx.createOscillator(); osc.type = 'triangle';
    const g = ctx.createGain();
    g.gain.setValueAtTime(0.0001, now);
    g.gain.exponentialRampToValueAtTime(vol, now + 0.02);
    g.gain.exponentialRampToValueAtTime(0.0001, now + dur);
    osc.frequency.setValueAtTime(f0, now);
    osc.frequency.exponentialRampToValueAtTime(f1, now + dur);
    // noise
    const noiseDur = Math.min(dur*0.55, 0.1);
    const buffer = ctx.createBuffer(1, Math.floor(ctx.sampleRate*noiseDur), ctx.sampleRate);
    const data = buffer.getChannelData(0);
    for (let i=0;i<data.length;i++) data[i] = (Math.random()*2-1)*0.55;
    const noise = ctx.createBufferSource(); noise.buffer = buffer;
    const band = ctx.createBiquadFilter(); band.type = 'bandpass'; band.frequency.value = 1200; band.Q.value = 1.1;
    const ng = ctx.createGain();
    ng.gain.setValueAtTime(0.0001, now);
    ng.gain.exponentialRampToValueAtTime(vol*0.6, now + 0.01);
    ng.gain.exponentialRampToValueAtTime(0.0001, now + noiseDur);
    // connect
    osc.connect(g).connect(ctx.destination);
    noise.connect(band).connect(ng).connect(ctx.destination);
    // play
    osc.start(now); osc.stop(now + dur + 0.02);
    noise.start(now + 0.005); noise.stop(now + noiseDur + 0.01);
  }
  function quackTriple(){
    const gap = 0.08;
    singleQuack(0.28, 0.15, 520, 240);
    setTimeout(()=>singleQuack(0.28, 0.14, 500, 230), gap*1000);
    setTimeout(()=>singleQuack(0.30, 0.16, 540, 250), gap*2*1000);
  }

  // é€ å‹
  function colorByIndex(i,n){ const h=Math.round((360*i)/n); return `hsl(${h} 80% 55%)`; }
  function cuteDuckSVG(bodyColor){
    const wing = 'rgba(255,255,255,0.35)';
    const stroke = 'rgba(0,0,0,0.15)';
    return `
    <svg viewBox="0 0 120 96" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
      <defs>
        <radialGradient id="g1" cx="40%" cy="35%" r="80%">
          <stop offset="0%" stop-color="white" stop-opacity="0.5"/>
          <stop offset="100%" stop-color="${bodyColor}" stop-opacity="1"/>
        </radialGradient>
      </defs>
      <path d="M22 66c0-18 18-30 42-30s42 12 42 30-18 26-42 26H38C29 92 22 85 22 76z"
            fill="url(#g1)" stroke="${stroke}" stroke-width="2"/>
      <circle cx="50" cy="34" r="18" fill="${bodyColor}" stroke="${stroke}" stroke-width="2"/>
      <path d="M58 62c-8 0-14 6-14 12 0 5 5 10 12 10 9 0 17-8 20-14-5-5-10-8-18-8z"
            fill="${wing}"/>
      <path d="M60 36c10 0 18 3 22 7-4 4-12 7-22 7-5 0-9-5-9-7s4-7 9-7z" fill="#f6a21a" stroke="${stroke}" stroke-width="1.2"/>
      <circle cx="56" cy="30" r="3.2" fill="#2b2b2b"/>
      <circle cx="55" cy="29" r="1.1" fill="#fff"/>
      <circle cx="46" cy="40" r="3.8" fill="#ff9fb1" opacity="0.45"/>
    </svg>`;
  }
  function displayName(i){ return "#" + (i+1); }
  function randSpeed(){ 
    // ä½¿ç”¨æŒ‡æ•°åˆ†å¸ƒæ¥å¢åŠ é€Ÿåº¦å·®å¼‚
    const exponent = 2.5; // æŒ‡æ•°å€¼è¶Šå¤§ï¼Œé€Ÿåº¦å·®å¼‚è¶Šå¤§
    const normalized = Math.pow(Math.random(), exponent);
    return SPEED_MIN + normalized * (SPEED_MAX - SPEED_MIN);
  }

  // æ˜¾ç¤ºå† å†›å¼¹çª—
  function showWinnerModal(winner) {
    if (!settings.showWinnerModal) return;
    
    const modal = document.createElement('div');
    modal.className = 'winner-modal';
    const isChinese = settings.language === 'zh';
    
    modal.innerHTML = `
      <div class="winner-content">
        <div class="winner-title">ğŸ† ${isChinese ? 'å† å†›è¯ç”Ÿï¼' : 'Winner!'} ğŸ†</div>
        <div class="winner-info">${isChinese ? 'å† å†›æ˜¯ï¼š' : 'Winner: '}<strong>${isChinese ? 'é¸­å­' : 'Duck'} ${displayName(winner.id-1)}</strong></div>
        <div class="winner-time">${isChinese ? 'ç”¨æ—¶ï¼š' : 'Time: '}${winner.finishTime.toFixed(4)} ${isChinese ? 'ç§’' : 's'}</div>
        <button class="close-winner">${isChinese ? 'æ­å–œå† å†›ï¼' : 'Congratulations!'}</button>
      </div>
    `;
    
    document.body.appendChild(modal);
    
    // ç‚¹å‡»å…³é—­å¼¹çª—
    modal.querySelector('.close-winner').addEventListener('click', () => {
      document.body.removeChild(modal);
    });
    
    // ç‚¹å‡»èƒŒæ™¯ä¹Ÿå¯ä»¥å…³é—­
    modal.addEventListener('click', (e) => {
      if (e.target === modal) {
        document.body.removeChild(modal);
      }
    });
  }
  
  // æ˜¾ç¤ºè®¾ç½®å¼¹çª—
  function showSettingsModal() {
    const modal = document.createElement('div');
    modal.className = 'settings-modal';
    const isChinese = settings.language === 'zh';
    
    modal.innerHTML = `
      <div class="settings-content">
        <div class="settings-title">${isChinese ? 'è®¾ç½®' : 'Settings'}</div>
        
        <div class="settings-group">
          <label class="settings-label">${isChinese ? 'è¯­è¨€' : 'Language'}</label>
          <select class="settings-select" id="settingLanguage">
            <option value="zh" ${settings.language === 'zh' ? 'selected' : ''}>ä¸­æ–‡</option>
            <option value="en" ${settings.language === 'en' ? 'selected' : ''}>English</option>
          </select>
        </div>
        
        <div class="settings-group">
          <div class="checkbox-container">
            <input type="checkbox" class="settings-checkbox" id="settingShowWinner" ${settings.showWinnerModal ? 'checked' : ''}>
            <label for="settingShowWinner">${isChinese ? 'æ˜¾ç¤ºå† å†›å¼¹çª—' : 'Show Winner Popup'}</label>
          </div>
          
          <div class="checkbox-container">
            <input type="checkbox" class="settings-checkbox" id="settingSound" ${settings.soundOn ? 'checked' : ''}>
            <label for="settingSound">${isChinese ? 'å¼€å¯å£°éŸ³' : 'Enable Sound'}</label>
          </div>
        </div>
        
        <div class="settings-footer">
          <a href="https://github.com/CreatorFMZ/Duck-swimming-competition" target="_blank" class="github-link">${isChinese ? 'è½¬åˆ°https://github.com/CreatorFMZ/Duck-swimming-competitionä»¥è·å–æœ€æ–°ç‰ˆ' : 'Go to https://github.com/CreatorFMZ/Duck-swimming-competition for the latest version'}</a>
        </div>
        
        <button class="close-settings">${isChinese ? 'ä¿å­˜è®¾ç½®' : 'Save Settings'}</button>
      </div>
    `;
    
    document.body.appendChild(modal);
    
    // ç‚¹å‡»ä¿å­˜è®¾ç½®
    modal.querySelector('.close-settings').addEventListener('click', () => {
      settings.language = document.getElementById('settingLanguage').value;
      settings.showWinnerModal = document.getElementById('settingShowWinner').checked;
      settings.soundOn = document.getElementById('settingSound').checked;
      
      saveSettings();
      updateLanguage();
      document.body.removeChild(modal);
    });
    
    // ç‚¹å‡»èƒŒæ™¯ä¹Ÿå¯ä»¥å…³é—­
    modal.addEventListener('click', (e) => {
      if (e.target === modal) {
        document.body.removeChild(modal);
      }
    });
  }
  
  // ä¿å­˜è®¾ç½®åˆ°localStorage
  function saveSettings() {
    localStorage.setItem('duckRaceSettings', JSON.stringify(settings));
  }
  
  // åŠ è½½è®¾ç½®
  function loadSettings() {
    const saved = localStorage.getItem('duckRaceSettings');
    if (saved) {
      const parsed = JSON.parse(saved);
      settings.language = parsed.language || 'zh';
      settings.showWinnerModal = parsed.showWinnerModal !== undefined ? parsed.showWinnerModal : true;
      settings.soundOn = parsed.soundOn !== undefined ? parsed.soundOn : true;
    }
  }
  
  // æ›´æ–°é¡µé¢è¯­è¨€
  function updateLanguage() {
    const lang = settings.language;
    const t = translations[lang];
    
    // æ›´æ–°æ‰€æœ‰ç•Œé¢å…ƒç´ 
    document.getElementById('pageTitle').textContent = t.title;
    document.getElementById('duckCountLabel').innerHTML = t.duckCount + '<input id="n" type="number" min="1" max="2147483648" value="5" />';
    document.getElementById('speedMultiplierLabel').innerHTML = t.speedMultiplier + '<input id="speedMul" type="number" min="0.01" max="100" step="0.01" value="1" />';
    document.getElementById('btnStart').textContent = t.startRace;
    document.getElementById('btnReset').textContent = t.reset;
    document.getElementById('btnSettings').textContent = t.settings;
    document.getElementById('statusLabel').innerHTML = t.status + '<span id="status">ç­‰å¾…å¼€å§‹</span>';
    document.getElementById('finishedLabel').innerHTML = t.finished + '<span id="doneCnt">0</span>/<span id="totalCnt">5</span>';
    document.getElementById('timeUsedLabel').innerHTML = t.timeUsed + '<span id="elapsed">0.0000s</span>';
    document.getElementById('raceResultTitle').textContent = t.raceResult;
    
    // é‡æ–°ç»‘å®šäº‹ä»¶
    setupEventListeners();
  }
  
  // æ›´æ–°æ€»é¸­å­æ•°é‡æ˜¾ç¤º
  function updateTotalCount() {
    document.getElementById('totalCnt').textContent = document.getElementById('n').value;
  }
  
  // éªŒè¯é€Ÿåº¦å€æ•°è¾“å…¥
  function validateSpeedMultiplier() {
    const elSpeedMul = document.getElementById('speedMul');
    let value = parseFloat(elSpeedMul.value);
    if (isNaN(value) || value < 0.01) {
      elSpeedMul.value = 0.01;
    } else if (value > 100) {
      elSpeedMul.value = 100;
    }
  }

  function resetAll(clear=true){
    cancelAnimationFrame(rafId);
    if (speedTimer) clearInterval(speedTimer);
    if (quackTimer) clearInterval(quackTimer);
    running = false;
    ducks = [];
    startPerf = lastPerf = 0;
    document.getElementById('doneCnt').textContent = '0';
    document.getElementById('elapsed').textContent = '0.0000s';
    document.getElementById('status').textContent = translations[settings.language].waiting;
    document.getElementById('rankList').innerHTML = '';
    if (clear) {
      const wrap = document.getElementById('trackWrap');
      wrap.querySelectorAll('.duck,.label').forEach(n=>n.remove());
    }
  }

  function buildDucks(N){
    const wrap = document.getElementById('trackWrap');
    finishX = wrap.clientWidth - FINISH_RIGHT_PADDING;
    document.getElementById('totalCnt').textContent = String(N);
    const H = wrap.clientHeight;
    for(let i=0;i<N;i++){
      const id = i+1;
      const label = document.createElement('div');
      label.className = 'label';
      label.textContent = displayName(i);
      wrap.appendChild(label);

      const duck = document.createElement('div');
      duck.className = 'duck';
      duck.innerHTML = cuteDuckSVG(colorByIndex(i,N));
      wrap.appendChild(duck);

      const duckH = 52;
      const y = Math.max(12, Math.min(H - duckH - 12, Math.random()*(H - duckH)));
      duck.style.top = y + 'px';
      duck.style.left = LEFT_PAD + 'px';
      label.style.top = (y) + 'px';
      label.style.left = (LEFT_PAD + 32) + 'px';

      ducks.push({ id, duckEl: duck, labelEl: label, x: LEFT_PAD, y, speed: randSpeed(), finished:false, finishTime:null });
    }
  }

  function startRace(){
    if (running) return;
    const N = Math.max(1, Math.min(65535, parseInt(document.getElementById('n').value||'5',10)));
    const speedMultiplier = parseFloat(document.getElementById('speedMul').value);
    resetAll(true);
    buildDucks(N);
    document.getElementById('status').textContent = translations[settings.language].racing;
    running = true;
    startPerf = lastPerf = performance.now();

    // å¼€èµ›ï¼šéšæœº 30% ä¸‰è¿å˜
    ducks.forEach(()=>{ if (Math.random()<0.3) setTimeout(quackTriple, 80 + Math.random()*320); });

    // æ¯ç§’åˆ·æ–°é€Ÿåº¦
    speedTimer = setInterval(()=>{
      ducks.forEach(d=>{ if(!d.finished) d.speed = randSpeed(); });
    }, 1000);

    // æ¯”èµ›ä¸­ï¼šæ¯ 1s æœ‰ 40% æ¦‚ç‡ä¸‰è¿å˜ä¸€æ¬¡
    quackTimer = setInterval(()=>{
      if (Math.random() < 0.4) quackTriple();
    }, 1000);

    const step = (now)=>{
      rafId = requestAnimationFrame(step);
      const dt = (now - lastPerf)/1000; lastPerf = now;
      const elapsed = (now - startPerf)/1000; 
      document.getElementById('elapsed').textContent = elapsed.toFixed(4)+'s';

      ducks.forEach(d=>{
        if (d.finished) return;
        d.x += d.speed * UNIT_TO_PX * dt * speedMultiplier;
        if (d.x >= finishX){
          d.x = finishX; 
          d.finished = true; 
          d.finishTime = elapsed; 
          d.duckEl.classList.add('finish');
          
          // 0.3ç§’å†…é€æ¸éšè—
          setTimeout(() => {
            d.duckEl.classList.add('hiding');
            d.labelEl.classList.add('hiding');
          }, 100);
          
          // 0.35ç§’åå®Œå…¨ç§»é™¤DOMå…ƒç´ 
          setTimeout(() => {
            if (d.duckEl.parentNode) d.duckEl.remove();
            if (d.labelEl.parentNode) d.labelEl.remove();
          }, 350);
          
          if (Math.random() < 0.6) quackTriple();
        }
        d.duckEl.style.left = d.x + 'px';
        d.labelEl.style.left = (d.x + 32) + 'px';
      });

      const done = ducks.filter(d=>d.finished).length;
      document.getElementById('doneCnt').textContent = String(done);
      if (done === ducks.length){
        running = false; 
        document.getElementById('status').textContent = translations[settings.language].ended;
        clearInterval(speedTimer); 
        clearInterval(quackTimer); 
        cancelAnimationFrame(rafId);
        
        // ç»ˆç‚¹åº†ç¥ï¼šä¸‰è¿å˜ * 3
        setTimeout(quackTriple, 100);
        setTimeout(quackTriple, 350);
        setTimeout(quackTriple, 600);
        
        // æ˜¾ç¤ºæ’å
        showRanking();
        
        // æ˜¾ç¤ºå† å†›å¼¹çª—
        const sorted = [...ducks].sort((a,b)=>a.finishTime - b.finishTime);
        if (sorted.length > 0) {
          setTimeout(() => showWinnerModal(sorted[0]), 800);
        }
      }
    };
    requestAnimationFrame(step);
  }

  function showRanking(){
    const sorted = [...ducks].sort((a,b)=>a.finishTime - b.finishTime);
    const rankList = document.getElementById('rankList');
    rankList.innerHTML = '';
    const isChinese = settings.language === 'zh';
    
    sorted.forEach((d, idx)=>{
      const li = document.createElement('li');
      li.textContent = `${isChinese ? 'ç¬¬' : ''} ${idx+1} ${isChinese ? 'åï¼šé¸­å­' : 'Place: Duck'} #${d.id}ï¼ˆ${isChinese ? 'ç”¨æ—¶' : 'Time'} ${d.finishTime.toFixed(4)} sï¼‰`;
      rankList.appendChild(li);
    });
  }

  // äº‹ä»¶ç›‘å¬å™¨
  function setupEventListeners() {
    // æ¸…é™¤ç°æœ‰äº‹ä»¶ç›‘å¬å™¨
    const btnStart = document.getElementById('btnStart');
    const btnReset = document.getElementById('btnReset');
    const btnSettings = document.getElementById('btnSettings');
    const elN = document.getElementById('n');
    const elSpeedMul = document.getElementById('speedMul');
    
    // å…‹éš†å¹¶æ›¿æ¢å…ƒç´ ä»¥ç§»é™¤æ—§çš„äº‹ä»¶ç›‘å¬å™¨
    const newBtnStart = btnStart.cloneNode(true);
    const newBtnReset = btnReset.cloneNode(true);
    const newBtnSettings = btnSettings.cloneNode(true);
    const newElN = elN.cloneNode(true);
    const newElSpeedMul = elSpeedMul.cloneNode(true);
    
    btnStart.parentNode.replaceChild(newBtnStart, btnStart);
    btnReset.parentNode.replaceChild(newBtnReset, btnReset);
    btnSettings.parentNode.replaceChild(newBtnSettings, btnSettings);
    elN.parentNode.replaceChild(newElN, elN);
    elSpeedMul.parentNode.replaceChild(newElSpeedMul, elSpeedMul);
    
    // æ·»åŠ æ–°çš„äº‹ä»¶ç›‘å¬å™¨
    newBtnStart.addEventListener('click', ()=>{ initAudio(); startRace(); });
    newBtnReset.addEventListener('click', ()=> resetAll(true));
    newBtnSettings.addEventListener('click', showSettingsModal);
    newElN.addEventListener('input', updateTotalCount);
    newElSpeedMul.addEventListener('input', validateSpeedMultiplier);
  }

  // åˆå§‹åŒ–
  function init() {
    loadSettings();
    updateLanguage();
    document.getElementById('totalCnt').textContent = document.getElementById('n').value;
    resetAll(true);
  }

  // å¯åŠ¨åº”ç”¨
  init();
})();
</script>
</body>
</html>